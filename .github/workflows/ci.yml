name: CI/CD

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  schedule:
    # Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð² Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 02:00 UTC
    - cron: '0 2 * * 0'

env:
  GO_VERSION: '1.24.1'

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run vet
      run: go vet ./...

    - name: Install staticcheck
      run: go install honnef.co/go/tools/cmd/staticcheck@latest

    - name: Run staticcheck
      run: staticcheck ./...

    - name: Run unit tests
      run: go test -v -race -coverprofile=coverage.out ./internal/config ./internal/models ./internal/version ./pkg/utils ./internal/services ./internal/cli ./internal/ui

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella

    - name: Wait for MySQL to be ready
      run: |
        while ! mysqladmin ping -h"127.0.0.1" -P3306 -uroot -proot --silent; do
          echo "Waiting for MySQL..."
          sleep 2
        done

    - name: Create test database and user
      run: |
        mysql -h127.0.0.1 -P3306 -uroot -proot -e "CREATE DATABASE IF NOT EXISTS dbsync_test;"
        mysql -h127.0.0.1 -P3306 -uroot -proot -e "CREATE USER IF NOT EXISTS 'test_user'@'%' IDENTIFIED BY 'test_password';"
        mysql -h127.0.0.1 -P3306 -uroot -proot -e "GRANT ALL PRIVILEGES ON dbsync_test.* TO 'test_user'@'%';"
        mysql -h127.0.0.1 -P3306 -uroot -proot -e "FLUSH PRIVILEGES;"

    - name: Run integration tests
      env:
        DBSYNC_TEST_REMOTE_HOST: 127.0.0.1
        DBSYNC_TEST_REMOTE_PORT: 3306
        DBSYNC_TEST_REMOTE_USER: test_user
        DBSYNC_TEST_REMOTE_PASSWORD: test_password
        DBSYNC_TEST_LOCAL_HOST: 127.0.0.1
        DBSYNC_TEST_LOCAL_PORT: 3306
        DBSYNC_TEST_LOCAL_USER: test_user
        DBSYNC_TEST_LOCAL_PASSWORD: test_password
      run: go test -v -tags=integration ./test/integration

  build:
    needs: test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # Linux
          - goos: linux
            goarch: amd64
            platform: linux/amd64
          - goos: linux
            goarch: arm64
            platform: linux/arm64
          - goos: linux
            goarch: 386
            platform: linux/386
          # Windows
          - goos: windows
            goarch: amd64
            platform: windows/amd64
          - goos: windows
            goarch: 386
            platform: windows/386
          # macOS
          - goos: darwin
            goarch: amd64
            platform: darwin/amd64
          - goos: darwin
            goarch: arm64
            platform: darwin/arm64

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð²ÐµÑ€ÑÐ¸Ð¸

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Generate version info
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          VERSION="v0.0.0-main-$(git rev-parse --short HEAD)"
        else
          VERSION="v0.0.0-${GITHUB_REF#refs/heads/}-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        echo "git_commit=${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð°
        EXT=""
        if [ "${{ matrix.goos }}" = "windows" ]; then
          EXT=".exe"
        fi
        
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
        mkdir -p dist
        
        # Ð˜Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð°
        FILENAME="dbsync-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}${EXT}"
        
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹
        go build \
          -ldflags="-s -w -X 'db-sync-cli/internal/version.Version=${{ steps.version.outputs.version }}' \
                    -X 'db-sync-cli/internal/version.BuildDate=${{ steps.version.outputs.build_date }}' \
                    -X 'db-sync-cli/internal/version.GitCommit=${{ steps.version.outputs.git_commit }}'" \
          -o "dist/${FILENAME}" \
          ./cmd/dbsync
        
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð°Ñ€Ñ…Ð¸Ð²
        cd dist
        if [ "${{ matrix.goos }}" = "windows" ]; then
          zip "${FILENAME%.exe}.zip" "$FILENAME"
        else
          tar -czf "${FILENAME}.tar.gz" "$FILENAME"
        fi
        
        # Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ
        echo "Built: $FILENAME"
        ls -la

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dbsync-${{ matrix.goos }}-${{ matrix.goarch }}
        path: dist/
        retention-days: 30

  # Ð ÐµÐ»Ð¸Ð· Ð´Ð»Ñ Ñ‚ÐµÐ³Ð¾Ð² (ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐ»Ð¸Ð·Ñ‹)
  release-tag:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare release assets
      run: |
        mkdir -p release
        find artifacts/ -type f \( -name "*.zip" -o -name "*.tar.gz" \) | while read file; do
          filename=$(basename "$file")
          cp "$file" "release/$filename"
        done
        
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ checksums
        cd release
        sha256sum * > checksums.txt
        
        echo "Release files:"
        ls -la

    - name: Extract release notes
      id: release_notes
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ release notes Ð¸Ð· CHANGELOG ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if [ -f CHANGELOG.md ]; then
          awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md > release_notes.txt
        fi
        
        if [ ! -s release_notes.txt ]; then
          echo "ðŸš€ Ð ÐµÐ»Ð¸Ð· $VERSION" > release_notes.txt
          echo "" >> release_notes.txt
          echo "### ðŸ“¦ Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾:" >> release_notes.txt
          echo "- Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "### ðŸ’¾ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ:" >> release_notes.txt
          echo "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹ Ð½Ð¸Ð¶Ðµ." >> release_notes.txt
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        body_path: release_notes.txt
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€ÐµÐ»Ð¸Ð· Ð´Ð»Ñ main Ð²ÐµÑ‚ÐºÐ¸ (nightly builds)
  release-nightly:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [test, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare nightly release
      run: |
        mkdir -p release
        find artifacts/ -type f \( -name "*.zip" -o -name "*.tar.gz" \) | while read file; do
          filename=$(basename "$file")
          cp "$file" "release/$filename"
        done
        
        cd release
        sha256sum * > checksums.txt
        
        echo "Nightly build files:"
        ls -la

    - name: Delete existing nightly release
      continue-on-error: true
      run: |
        gh release delete nightly --yes || true
        git push origin --delete nightly || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create nightly tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -f nightly
        git push origin nightly --force

    - name: Create Nightly Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly
        name: "ðŸŒ™ Nightly Build"
        files: release/*
        body: |
          ðŸŒ™ **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ð¸Ð· main Ð²ÐµÑ‚ÐºÐ¸**
          
          âš ï¸ **Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ**: Ð­Ñ‚Ð¾ ÑÐºÑÐ¿ÐµÑ€Ð¸Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ°, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð½ÐµÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ.
          
          ðŸ“… **Ð”Ð°Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          ðŸ”— **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚**: ${{ github.sha }}
          
          ### ðŸ“¦ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹:
          - **Linux**: x86_64, ARM64, i386
          - **Windows**: x86_64, i386  
          - **macOS**: Intel (x86_64), Apple Silicon (ARM64)
          
          ### ðŸš€ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:
          1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð² Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
          2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð²
          3. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð² Ð¿Ð°Ð¿ÐºÑƒ PATH
          
          ðŸ’¾ **ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸**: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `checksums.txt` Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ SHA256
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð· Ð´Ð»Ñ develop Ð²ÐµÑ‚ÐºÐ¸
  release-weekly:
    if: github.ref == 'refs/heads/develop' && github.event_name == 'schedule'
    needs: [test, build] 
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare weekly release
      run: |
        mkdir -p release
        find artifacts/ -type f \( -name "*.zip" -o -name "*.tar.gz" \) | while read file; do
          filename=$(basename "$file")
          cp "$file" "release/$filename"
        done
        
        cd release
        sha256sum * > checksums.txt

    - name: Delete existing weekly release  
      continue-on-error: true
      run: |
        gh release delete weekly --yes || true
        git push origin --delete weekly || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create weekly tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        WEEK=$(date +%Y-W%V)
        git tag -f weekly
        git push origin weekly --force

    - name: Create Weekly Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: weekly
        name: "ðŸ“… Weekly Development Build"
        files: release/*
        body: |
          ðŸ“… **Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ð¸Ð· develop Ð²ÐµÑ‚ÐºÐ¸**
          
          ðŸš§ **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹
          
          ðŸ“… **ÐÐµÐ´ÐµÐ»Ñ**: $(date +%Y-W%V)
          ðŸ”— **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚**: ${{ github.sha }}
          
          ### ðŸ§ª Ð”Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð²:
          Ð­Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð· develop Ð²ÐµÑ‚ÐºÐ¸ Ð¸ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð° Ð´Ð»Ñ:
          - Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹
          - Ð Ð°Ð½Ð½ÐµÐ³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸ÑÐ¼
          - ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð¾Ð¹ ÑÐ²ÑÐ·Ð¸ Ð¾Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð°
          
          âš ï¸ **ÐÐµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ñ€ÐµÐ»Ð¸Ð·Ð°Ñ…
  notify:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [release-tag]
    runs-on: ubuntu-latest
    
    steps:
    - name: Extract version
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create summary
      run: |
        echo "# ðŸš€ Ð ÐµÐ»Ð¸Ð· ${{ steps.version.outputs.version }} Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸:" >> $GITHUB_STEP_SUMMARY
        echo "- **Linux**: x86_64, ARM64, i386" >> $GITHUB_STEP_SUMMARY
        echo "- **Windows**: x86_64, i386" >> $GITHUB_STEP_SUMMARY  
        echo "- **macOS**: Intel (x86_64), Apple Silicon (ARM64)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ¸:" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“‹ Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“¦ Ð’ÑÐµ Ñ€ÐµÐ»Ð¸Ð·Ñ‹](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
