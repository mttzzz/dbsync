# DB Sync CLI Tool - Архитектура и План Разработки

## Описание проекта

Консольная утилита на Go для синхронизации MySQL баз данных между удаленным сервером и локальной машиной с красивым интерфейсом и отображением прогресса.

## Требования

- [x] Консольная утилита на Go
- [x] Интерактивный выбор базы данных для синхронизации
- [x] Создание дампа удаленной MySQL базы данных
- [x] Восстановление дампа в локальную MySQL
- [x] Красивое отображение процесса выполнения
- [x] Поддержка переменных окружения
- [x] Покрытие тестами
- [x] Возможность автоматической синхронизации без интерактива

## Архитектура

### Компоненты системы

1. **CLI Interface** - интерактивный интерфейс командной строки
2. **Database Service** - сервис для работы с MySQL (удаленной и локальной)
3. **Dump Service** - сервис для создания и восстановления дампов
4. **Progress Display** - красивое отображение прогресса операций
5. **Configuration** - управление конфигурацией через env переменные

### Структура проекта

```
db-sync-cli/
├── cmd/
│   └── dbsync/
│       └── main.go              # Точка входа приложения
├── internal/
│   ├── config/
│   │   └── config.go            # Конфигурация и env переменные
│   ├── cli/
│   │   ├── interactive.go       # Интерактивный режим
│   │   └── commands.go          # CLI команды
│   ├── services/
│   │   ├── database.go          # Сервис для работы с БД
│   │   ├── dump.go              # Сервис создания/восстановления дампов
│   │   └── sync.go              # Основной сервис синхронизации
│   ├── ui/
│   │   ├── progress.go          # Отображение прогресса
│   │   └── formatter.go         # Форматирование вывода
│   ├── models/
│   │   └── database.go          # Модели данных
│   └── version/
│       └── version.go           # Версия приложения
├── pkg/
│   └── utils/
│       └── validation.go        # Утилиты валидации
├── test/
│   ├── integration/             # Интеграционные тесты
│   └── mocks/                   # Моки для тестов
├── scripts/
│   ├── install.ps1              # PowerShell скрипт для установки
│   └── build.ps1                # Скрипт сборки
├── bin/                         # Скомпилированные бинарники
│   ├── dbsync.exe               # Windows бинарник
│   ├── dbsync-linux             # Linux бинарник
│   └── dbsync-darwin            # macOS бинарник
├── .env.example                 # Пример переменных окружения
├── .gitignore                   # Git ignore файл
├── go.mod
├── go.sum
├── Makefile                     # Команды для сборки и тестов
└── README.md
```

### CLI Команды

#### dbsync sync [database_name]
Синхронизирует указанную базу данных. Если имя не указано - показывает интерактивный выбор.

**Опции:**
- `--remote-host` - адрес удаленного сервера
- `--local-host` - адрес локального сервера  
- `--dry-run` - показать что будет сделано без выполнения
- `--force` - пропустить подтверждения
- `--verbose` - подробный вывод
- `--version, -v` - показать версию приложения

#### dbsync list
Показывает список доступных баз данных на удаленном сервере.

#### dbsync status
Проверяет доступность удаленного и локального серверов MySQL.

#### dbsync version
Показывает версию приложения.

**Ответ:**
```
dbsync version 1.0.0
Build: abc1234
Date: 2025-06-18
```

#### dbsync config
Показывает текущую конфигурацию.

### Пример использования

```bash
# Интерактивный режим
dbsync sync

# Синхронизация конкретной БД
dbsync sync my_database

# Предварительный просмотр
dbsync sync my_database --dry-run

# Автоматическая синхронизация без подтверждений
dbsync sync my_database --force

# Показать версию
dbsync version
# или
dbsync --version
```

### Установка и развертывание

#### Глобальная установка
```powershell
# Скопировать бинарник в глобальную папку
Copy-Item ".\bin\dbsync.exe" "C:\Users\kiril\utils\dbsync.exe"

# Добавить C:\Users\kiril\utils в PATH (если еще не добавлено)
[Environment]::SetEnvironmentVariable("Path", $env:Path + ";C:\Users\kiril\utils", "User")
```

#### Автоматическая установка
```powershell
# Запустить скрипт установки
.\scripts\install.ps1
```

### Переменные окружения

```env
# Настройки удаленного MySQL сервера
REMOTE_MYSQL_HOST=your-remote-server.com
REMOTE_MYSQL_PORT=3306
REMOTE_MYSQL_USER=username
REMOTE_MYSQL_PASSWORD=password

# Настройки локального MySQL сервера
LOCAL_MYSQL_HOST=localhost
LOCAL_MYSQL_PORT=3306
LOCAL_MYSQL_USER=root
LOCAL_MYSQL_PASSWORD=password

# Настройки дампа
DUMP_TIMEOUT=300s
TEMP_DIR=./tmp
MYSQLDUMP_PATH=mysqldump
MYSQL_PATH=mysql

# Настройки CLI
DEFAULT_CHARSET=utf8mb4
INTERACTIVE_MODE=true
CONFIRM_DESTRUCTIVE=true

# Настройки логирования
LOG_LEVEL=info
LOG_FORMAT=text
```

### Интерактивный интерфейс

1. **Выбор базы данных** - список с возможностью поиска
2. **Подтверждение операции** - показ что будет заменено
3. **Прогресс-бар** - для операций дампа и восстановления
4. **Красивые уведомления** - успех, ошибки, предупреждения
5. **Время выполнения** - отображение времени операций

### Безопасность

1. **Валидация входных данных** - проверка имени базы данных
2. **Подтверждение деструктивных операций** - предупреждение о замене локальной БД
3. **Безопасное хранение паролей** - только через env переменные
4. **Таймауты** - ограничение времени выполнения операций
5. **Очистка временных файлов** - автоматическое удаление дампов

### Технологический стек

- **Go 1.21+** - основной язык
- **Cobra** - CLI фреймворк
- **Viper** - управление конфигурацией  
- **Bubble Tea** - красивый TUI интерфейс
- **Lipgloss** - стилизация терминала
- **mysqldump/mysql** - утилиты для работы с БД
- **testify** - фреймворк для тестирования
- **zap** - структурированное логирование

## План разработки

### Этап 1: Основная структура и CLI
- [x] Инициализация Go модуля и Git репозитория
- [x] Создание .gitignore файла
- [x] Создание базовой структуры папок
- [x] Настройка версионирования приложения
- [x] Настройка конфигурации и env переменных
- [x] Создание основных CLI команд с Cobra

### Этап 2: Сервисы для работы с БД
- [x] Реализация подключения к удаленному и локальному MySQL
- [x] Создание сервиса для получения списка БД
- [x] Добавление валидации подключений

### Этап 3: Дамп и восстановление
- [x] Реализация создания дампа с удаленного сервера
- [x] Создание восстановления дампа в локальную БД
- [x] Обработка ошибок и таймаутов
- [x] Система безопасности с dry-run по умолчанию

### Этап 4: Интерактивный интерфейс
- [x] Интерактивный выбор базы данных  
- [x] Красивое отображение прогресса
- [x] Подтверждение деструктивных операций
- [x] Стилизованный вывод с цветами и эмодзи

### Этап 5: Тестирование
- [ ] Unit тесты для всех сервисов
- [ ] Интеграционные тесты
- [ ] Создание моков для тестирования

### Этап 6: Финализация и документация
- [ ] Скрипты сборки для разных платформ
- [ ] PowerShell скрипт для автоматической установки
- [ ] README с инструкциями по использованию
- [ ] Makefile с командами сборки
- [ ] Настройка CI/CD для автоматической сборки
- [ ] Создание releases с бинарниками

## Дополнительные возможности (будущие итерации)

- [ ] Поддержка PostgreSQL
- [ ] Планировщик для автоматической синхронизации
- [ ] Конфигурационные профили для разных окружений
- [ ] Инкрементальная синхронизация
- [ ] Сжатие дампов для больших БД
- [ ] Веб-интерфейс для управления
- [ ] Уведомления в Slack/Teams о синхронизации
- [ ] Бэкап перед заменой локальной БД

---

## Статус выполнения

**Текущий этап:** Этап 4 завершен ✅ (красивый интерфейс готов)
**Следующий шаг:** Этап 5 - Тестирование

**Последнее обновление:** 18 июня 2025

### Git репозиторий и версионирование

#### Версионирование
- Использование семантического версионирования (SemVer): `MAJOR.MINOR.PATCH`
- Версия встраивается в бинарник во время сборки
- Информация о версии, коммите и дате сборки доступна через `dbsync version`

#### .gitignore
```gitignore
# Бинарные файлы
/bin/
*.exe

# Временные файлы
/tmp/
*.tmp
*.log

# Go специфичные файлы
vendor/
*.test
*.out

# IDE файлы
.vscode/
.idea/
*.swp
*.swo

# Конфигурационные файлы с секретами
.env
.env.local

# OS специфичные файлы
.DS_Store
Thumbs.db
```

#### Git hooks
- Pre-commit: запуск тестов и линтера
- Pre-push: проверка, что все тесты проходят
